<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AgroVision is a mobile-first web app that helps farmers diagnose plant diseases, check market prices, and get weather updates." />
    <link rel="manifest" href="./manifest.json">
    <title>AgroVision App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="./tailwind.css"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.3s ease;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page {
            display: none;
            padding: 2rem 1rem;
            max-width: 600px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease-in-out;
            box-sizing: border-box;
            flex-grow: 1;
            overflow-y: auto;
            width: 100%;
            overflow: hidden;
        }

        .page.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glass-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            padding: 2.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .main-button {
            background-color: #22c55e;
            color: white;
            padding: 1rem 2rem;
            border-radius: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 10px rgba(0, 0, 0, 0.15);
        }

        input[type="file"] {
            display: none;
        }

        .nav-button {
            background-color: #f3f4f6;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
        }

        .nav-button:hover {
            background-color: #e5e7eb;
        }

        .nav-button.active {
            background-color: #d1fae5;
            color: #16a34a;
        }

        .history-item, .kb-item {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
        }

        .history-item:last-child, .kb-item:last-child {
            border-bottom: none;
        }

        .history-item-thumb, .kb-item-thumb {
            width: 4rem;
            height: 4rem;
            border-radius: 0.75rem;
            object-fit: cover;
            margin-right: 1rem;
        }

        .result-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 1.5rem;
            margin-bottom: 2rem;
        }

        .kb-list {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .kb-item:hover {
            background-color: #f9fafb;
        }

        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: #f3f4f6;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: white;
            padding: 1rem;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
            display: none; /* Hide by default */
            justify-content: space-between;
            align-items: center;
        }
        
        .fixed-footer.active {
            display: flex;
        }

        .content-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-top: 5rem;
            padding-bottom: 5rem;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #22c55e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles for the new sidebar menu */
        .sidebar-menu {
            position: fixed;
            top: 0;
            right: 0;
            width: 250px;
            height: 100%;
            background-color: white;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 20;
            padding-top: 5rem;
        }
        .sidebar-menu.active {
            transform: translateX(0);
        }
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 15;
            display: none;
        }
        .sidebar-overlay.active {
            display: block;
        }
        
        /* Chatbot specific styles */
        #chatbox {
            display: flex;
            flex-direction: column;
            width: 100%;
            flex-grow: 1;
            max-height: calc(100vh - 12rem);
            overflow-y: auto;
            padding: 1rem;
            border-radius: 1.5rem;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            margin-bottom: 1rem;
        }

        .chat-message {
            max-width: 80%;
            padding: 0.75rem 1.25rem;
            border-radius: 1.25rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }
        .chat-message.user {
            background-color: #d1fae5;
            color: #16a34a;
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-message.bot {
            background-color: #e5e7eb;
            color: #374151;
            align-self: flex-start;
            margin-right: auto;
        }

        #chat-input-container {
            width: 100%;
            display: flex;
            gap: 0.5rem;
        }
        #chat-input {
            flex-grow: 1;
            padding: 1rem;
            border-radius: 1.5rem;
            border: 2px solid #e5e7eb;
            outline: none;
            transition: border-color 0.2s;
        }
        #chat-input:focus {
            border-color: #22c55e;
        }
        #send-btn {
            background-color: #22c55e;
            color: white;
            border-radius: 50%;
            width: 3.5rem;
            height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        #send-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>

<header class="fixed-header">
    <nav class="w-full max-w-lg flex justify-between items-center px-4">
        <h1 id="appLogo" class="text-2xl font-bold text-gray-800 cursor-pointer">AgroVision</h1>
        <button id="menuBtn" class="p-2 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-800">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
    </nav>
</header>

<div id="sidebarOverlay" class="sidebar-overlay"></div>
<div id="sidebarMenu" class="sidebar-menu">
    <div class="flex flex-col items-start p-6 space-y-4">
        <button id="closeMenuBtn" class="self-end p-2 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <button id="weatherMenuBtn" class="nav-button w-full text-left">Weather</button>
        <button id="marketMenuBtn" class="nav-button w-full text-left">Market Prices</button>
        <button id="chatbotMenuBtn" class="nav-button w-full text-left">Agro-Assistant</button>
        <button id="profileMenuBtn" class="nav-button w-full text-left">Profile</button>
        <button id="logoutMenuBtn" class="nav-button w-full text-left bg-red-100 text-red-600 hover:bg-red-200">Logout</button>
    </div>
</div>

<div class="content-container">
    <div id="welcomePage" class="page active">
        <div class="flex flex-col items-center justify-center p-8 bg-white/80 backdrop-blur-md rounded-[2rem] shadow-xl">
            <img src="logo.jpeg" class="max-w-78" alt="">
            <p class="text-lg text-gray-600 mb-8 max-w-sm text-center">Your pocket guide to diagnosing plant health and finding solutions.</p>
            <button id="getStartedBtn" class="main-button">Get Started</button>
        </div>
    </div>

    <div id="loginPage" class="page">
        <div class="glass-card w-full flex flex-col items-center ">
            <img src="logo.jpeg" class="max-w-44" alt="">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Login</h1>
            <div class="space-y-4">
                <input type="tel" id="loginMobile" placeholder="Mobile Number" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-green-500">
                <input type="password" id="loginPassword" placeholder="Password" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-green-500">
                <button id="loginBtn" class="main-button w-full">Login</button>
            </div>
            <p class="mt-4 text-gray-600">Don't have an account? <a href="#" id="toSignupLink" class="text-green-500 font-semibold hover:underline">Sign Up</a></p>
        </div>
    </div>

    <div id="signupPage" class="page">
        <div class="glass-card w-full flex flex-col items-center ">
            <img src="logo.jpeg" class="max-w-44" alt="">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Sign Up</h1>
            <div class="space-y-4">
                <input type="text" id="signupName" placeholder="Full Name" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-green-500">
                <input type="tel" id="signupMobile" placeholder="Mobile Number" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-green-500">
                <input type="password" id="signupPassword" placeholder="Password" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-green-500">
                <button id="signupBtn" class="main-button w-full">Sign Up</button>
            </div>
            <p class="mt-4 text-gray-600">Already have an account? <a href="#" id="toLoginLink" class="text-green-500 font-semibold hover:underline">Login</a></p>
        </div>
    </div>

    <div id="mainPage" class="page">
        <div id="dashboardContent" class="w-full flex flex-col items-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2 mt-4">Hi, Ramu Kaka! üëã</h2>
            <p class="text-lg text-gray-600 mb-8">Ready to check on your plants?</p>
            
            <div class="glass-card w-full mb-6">
                <h3 class="text-2xl font-semibold text-gray-700 mb-6">Diagnose a Plant</h3>
                <p class="text-gray-500 mb-8">Take a clear picture or video of a leaf to get a diagnosis.</p>
                <div class="flex flex-col md:flex-row gap-4 justify-center">
                    <label for="imageUploadInput" class="main-button cursor-pointer w-full md:w-auto">
                        Upload Image
                    </label>
                    <label for="videoUploadInput" class="main-button cursor-pointer w-full md:w-auto">
                        Upload Video
                    </label>
                </div>
            </div>
            <input type="file" id="imageUploadInput" accept="image/*">
            <input type="file" id="videoUploadInput" accept="video/*">

            <div class="bg-white/70 backdrop-blur-md rounded-[1.5rem] shadow-lg p-6 w-full mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Your Recent Diagnosis</h3>
                <ul class="history-list" id="dashboardHistoryList">
                    <li class="history-item" data-history-id="tomatoHealthy">
                        <img src="https://images.unsplash.com/photo-1721520609152-0a02d79f46fe?q=80&w=1035&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Tomato Leaf" class="history-item-thumb">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Tomato Plant - Healthy</p>
                            <p class="text-sm text-gray-500">2 days ago</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        
        <div id="historyContent" class="hidden w-full flex flex-col items-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 mt-4">Diagnosis History</h1>
            <div class="bg-white/70 backdrop-blur-md rounded-[1.5rem] shadow-lg p-6 w-full">
                <ul class="history-list" id="historyList">
                    <li class="history-item" data-history-id="tomatoHealthy">
                        <img src="https://images.unsplash.com/photo-1721520609152-0a02d79f46fe?q=80&w=1035&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Tomato Leaf" class="history-item-thumb">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Tomato Plant - Healthy</p>
                            <p class="text-sm text-gray-500">2 days ago</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                    <li class="history-item" data-history-id="potatoBlight">
                        <img src="https://images.unsplash.com/photo-1718105314487-aabc56d0b2fc?q=80&w=1035&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Potato Leaf" class="history-item-thumb">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Potato Plant - Blight</p>
                            <p class="text-sm text-gray-500">5 days ago</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                    <li class="history-item" data-history-id="roseBlackSpot">
                        <img src="https://images.unsplash.com/photo-1663522850116-1b8ec49e76df?q=80&w=987&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Rose Leaf" class="history-item-thumb">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Rose Bush - Black Spot</p>
                            <p class="text-sm text-gray-500">1 week ago</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <div id="kbContent" class="hidden w-full flex flex-col items-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 mt-4">Plantpedia</h1>
            <div class="bg-white/70 backdrop-blur-md rounded-[1.5rem] shadow-lg p-6 w-full">
                <ul class="kb-list" id="kbList">
                    <li class="kb-item" data-topic="aphids">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Aphids</p>
                            <p class="text-sm text-gray-500">Common Pests</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                    <li class="kb-item" data-topic="powderyMildew">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Powdery Mildew</p>
                            <p class="text-sm text-gray-500">Fungal Disease</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                    <li class="kb-item" data-topic="nitrogenDeficiency">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Nitrogen Deficiency</p>
                            <p class="text-sm text-gray-500">Nutrient Deficiency</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <div id="marketPage" class="page">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 mt-4">Live Mandi Prices</h1>
        <div class="glass-card w-full p-6 text-left">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Prices in Jabalpur</h2>
            <p id="marketStatus" class="text-sm text-gray-600 mb-4">Live data from Agmarknet.</p>
            <ul id="marketPricesList" class="space-y-4">
                </ul>
        </div>
    </div>

    <div id="weatherPage" class="page">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 mt-4">Current Weather</h1>
        <div class="glass-card w-full flex flex-col items-center p-6 text-center">
            <h3 class="text-xl font-semibold text-gray-700" id="weatherLocation"></h3>
            <img id="weatherIcon" src="" alt="Weather icon" class="w-24 h-24 my-4">
            <p id="weatherTemp" class="text-5xl font-bold text-gray-800 my-2">--¬∞C</p>
            <p id="weatherCondition" class="text-xl text-gray-600 mb-4">Loading...</p>
            <p id="weatherAdvisory" class="mt-4 text-gray-600 text-sm leading-relaxed"></p>
        </div>
    </div>

    <div id="chatbotPage" class="page flex-col">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 mt-4">Agro-Assistant</h1>
        <div id="chatbox" class="flex-1 w-full flex flex-col items-start overflow-y-auto p-4">
            <div class="chat-message bot">‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ Agro-Assistant ‡§π‡•Ç‡§Å‡•§ ‡§´‡§∏‡§≤, ‡§ï‡•Ä‡§ü, ‡§Ø‡§æ ‡§Æ‡•å‡§∏‡§Æ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç‡•§</div>
        </div>
        <div id="chat-input-container" class="mt-4">
            <input type="text" id="chat-input" placeholder="‡§Ö‡§™‡§®‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç..." class="px-4 py-3 rounded-full border border-gray-300 w-full focus:outline-none focus:border-green-500">
            <button id="send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
            </button>
        </div>
    </div>

    <div id="kbDetailPage" class="page">
        <button id="kbBackBtn" class="self-start mb-4 px-4 py-2 bg-gray-200 text-gray-700 rounded-full font-semibold transition-colors duration-200 hover:bg-gray-300">
            &larr; Back
        </button>
        <div class="glass-card w-full">
            <h1 id="kbDetailTitle" class="text-3xl font-bold text-gray-800 mb-4"></h1>
            <p id="kbDetailDescription" class="text-gray-600 text-sm leading-relaxed mb-6 text-left"></p>
            <h2 class="text-xl font-bold text-gray-800 mb-2 text-left">Causes</h2>
            <p id="kbDetailCauses" class="text-gray-600 text-sm leading-relaxed mb-6 text-left"></p>
            <h2 class="text-xl font-bold text-gray-800 mb-2 text-left">Solutions</h2>
            <p id="kbDetailSolutions" class="text-gray-600 text-sm leading-relaxed text-left"></p>
            <div class="flex justify-center mt-6">
                <button id="readAloudBtn" class="flex items-center px-6 py-3 bg-blue-500 text-white rounded-full font-semibold hover:bg-blue-600 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L6.683 15H2a1 1 0 01-1-1V6a1 1 0 011-1h4.683l2.618-2.618a1 1 0 011.082-.306zM15.536 6.757a.75.75 0 011.06 1.06l-1.06 1.06.53.53a.75.75 0 01-1.06 1.06l-.53-.53-1.06 1.06a.75.75 0 01-1.06-1.06l1.06-1.06-.53-.53a.75.75 0 011.06-1.06l.53.53 1.06-1.06z" clip-rule="evenodd" />
                    </svg>
                    <span>Read Aloud ‚ú®</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="historyDetailPage" class="page">
        <button id="historyBackBtn" class="self-start mb-4 px-4 py-2 bg-gray-200 text-gray-700 rounded-full font-semibold transition-colors duration-200 hover:bg-gray-300">
            &larr; Back
        </button>
        <div class="glass-card w-full">
            <img id="historyImage" src="" alt="Diagnosed Leaf" class="result-image">
            <h2 id="historyTitle" class="text-3xl font-semibold text-gray-700 mb-2"></h2>
            <p id="historyStatus" class="text-xl font-medium mb-4"></p>
            <p id="historyDescription" class="text-gray-600 text-sm leading-relaxed mb-6 text-left"></p>
            <p id="historySolution" class="text-gray-600 text-sm leading-relaxed text-left"></p>
        </div>
    </div>

    <div id="resultPage" class="page">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 mt-4">Diagnosis Result</h1>
        <div class="glass-card w-full flex flex-col items-center">
            <div id="loading" class="hidden">
                <div class="loader mb-4"></div>
                <p class="text-gray-600">Analyzing plant... please wait.</p>
            </div>
            
            <img id="resultImage" src="" alt="Diagnosed Leaf" class="result-image hidden">
            
            <div id="resultContent" class="hidden w-full text-left">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h2 id="resultCropName" class="text-3xl font-semibold text-gray-700 mb-1"></h2>
                        <p id="resultHealthStatus" class="text-xl font-medium"></p>
                    </div>
                    <div class="bg-gray-500 text-white text-sm font-bold px-3 py-1 rounded-full" id="resultConfidence"></div>
                </div>
    
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Possible Issues</h3>
                    <ul id="resultIssuesList" class="list-disc list-inside space-y-1 text-gray-600"></ul>
                </div>
    
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Why This Is Happening</h3>
                    <ul id="resultReasonsList" class="list-disc list-inside space-y-1 text-gray-600"></ul>
                </div>
    
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Suggested Actions</h3>
                    <ul id="resultActionsList" class="list-decimal list-inside space-y-1 text-gray-600"></ul>
                </div>
    
                <div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Prevention Tips for Future</h3>
                    <ul id="resultTipsList" class="list-disc list-inside space-y-1 text-gray-600"></ul>
                </div>
            </div>

            <button id="goHomeBtn" class="mt-8 px-8 py-3 bg-gray-200 text-gray-700 rounded-full font-semibold transition-colors duration-200 hover:bg-gray-300 hidden">
                Go Home
            </button>
        </div>
    </div>

    <div id="profilePage" class="page">
        <div class="glass-card w-full">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">User Profile</h1>
            <div class="flex flex-col items-center space-y-4 mb-8">
                <img src="https://images.unsplash.com/photo-1595956481935-a9e254951d49?q=80&w=987&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="User Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800">Ramu Kaka</h2>
                <p class="text-gray-500 text-sm">Farmer from Jabalpur, India</p>
            </div>
            <div class="space-y-4 text-left w-full">
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500">üì±</span>
                    <p class="text-gray-600"><span class="font-semibold text-gray-800">Mobile No:</span> +91 9876543210</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500">üìç</span>
                    <p class="text-gray-600"><span class="font-semibold text-gray-800">Location:</span> Jabalpur, India</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500">üìÖ</span>
                    <p class="text-gray-600"><span class="font-semibold text-gray-800">Member Since:</span> January 2025</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500">üìä</span>
                    <p class="text-gray-600"><span class="font-semibold text-gray-800">Total Diagnoses:</span> 12</p>
                </div>
            </div>
            <!-- <button id="logoutBtn" class="mt-8 px-8 py-3 bg-red-500 text-white rounded-full font-semibold transition-colors duration-200 hover:bg-red-600">
                Logout
            </button> -->
        </div>
    </div>
</div>

<footer id="footer" class="fixed-footer">
    <button id="homeTabBtn" class="nav-button active">Dashboard</button>
    <button id="historyTabBtn" class="nav-button">History</button>
    <button id="kbTabBtn" class="nav-button">Plantpedia</button>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const pages = {
            welcome: document.getElementById('welcomePage'),
            login: document.getElementById('loginPage'),
            signup: document.getElementById('signupPage'),
            main: document.getElementById('mainPage'),
            result: document.getElementById('resultPage'),
            profile: document.getElementById('profilePage'),
            weather: document.getElementById('weatherPage'),
            market: document.getElementById('marketPage'),
            chatbot: document.getElementById('chatbotPage'),
            kbDetail: document.getElementById('kbDetailPage'),
            historyDetail: document.getElementById('historyDetailPage')
        };
        const tabs = {
            dashboard: document.getElementById('dashboardContent'),
            history: document.getElementById('historyContent'),
            kb: document.getElementById('kbContent')
        };
        const footerTabs = {
            dashboard: document.getElementById('homeTabBtn'),
            history: document.getElementById('historyTabBtn'),
            kb: document.getElementById('kbTabBtn')
        };
        const footer = document.getElementById('footer');
        const menuBtn = document.getElementById('menuBtn');
        const sidebarMenu = document.getElementById('sidebarMenu');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const appLogo = document.getElementById('appLogo');
        const loadingSpinner = document.getElementById('loading');
        const resultCard = document.getElementById('resultCard');

        // Data for Knowledge Base details
        const kbData = {
            aphids: {
                title: "Aphids",
                description: "Aphids are small, sap-sucking insects that can be green, black, brown, or pink. They are often found in clusters on the undersides of leaves and on new growth.",
                causes: "Aphid infestations typically occur when there is an imbalance in the ecosystem, such as a lack of natural predators like ladybugs. They can also be introduced from new plants or by wind.",
                solutions: "For a minor infestation, a strong spray of water from a hose can dislodge them. For a more severe problem, use insecticidal soap or neem oil. Encourage beneficial insects by planting flowers like marigolds and dill."
            },
            powderyMildew: {
                title: "Powdery Mildew",
                description: "Powdery mildew is a common fungal disease that appears as a white, powdery coating on the surface of leaves and stems. It can stunt growth and distort new leaves.",
                causes: "This fungus thrives in dry climates with high humidity. Overcrowded plants with poor air circulation are more susceptible, as are plants that are over-fertilized with high-nitrogen fertilizers.",
                solutions: "Prune affected leaves and stems to improve air circulation. Apply a fungicide, such as a mixture of baking soda and water or a commercial product. Avoid watering from overhead to keep foliage dry."
            },
            nitrogenDeficiency: {
                title: "Nitrogen Deficiency",
                description: "Nitrogen is a crucial nutrient for plant growth, particularly for developing healthy green foliage. A deficiency causes stunted growth and yellowing of older leaves, starting from the tips and moving inward.",
                causes: "Nitrogen deficiency is often caused by poor soil quality, leaching due to excessive watering, or a lack of organic matter. Sandy soils are particularly prone to this issue.",
                solutions: "Apply a balanced, slow-release fertilizer or a fertilizer high in nitrogen. Add organic matter like compost or aged manure to the soil. For a quick fix, use a liquid feed rich in nitrogen."
            }
        };

        // Added mock data for history entries
        const historyData = {
            tomatoHealthy: {
                title: 'Tomato Plant',
                status: 'Status: Healthy',
                statusColor: '#22c55e',
                description: 'This tomato plant appears to be in excellent health. The leaves are vibrant green and show no signs of common pests or fungal infections.',
                solution: 'Keep up the good work! Ensure the plant receives adequate sunlight (6-8 hours daily) and water it regularly, but avoid overwatering. Fertilize once a month during the growing season.',
                imageSrc: 'https://placehold.co/400x300/EBF4F5/6B7280?text=Healthy+Tomato'
            },
            potatoBlight: {
                title: 'Potato Plant',
                status: 'Status: Blight Detected',
                statusColor: '#ef4444',
                description: 'Late blight is a serious fungal disease caused by the oomycete Phytophthora infestans. It can affect all parts of the potato plant, with symptoms including dark, water-soaked spots on leaves and stems.',
                solution: 'Treatment is essential. Remove all infected leaves and stems immediately. Apply a fungicidal spray containing copper or mancozeb. Ensure proper air circulation by pruning the plant. Dispose of infected plant material responsibly to prevent spread.',
                imageSrc: 'https://placehold.co/400x300/EBF4F5/6B7280?text=Potato+Blight'
            },
            roseBlackSpot: {
                title: 'Rose Bush',
                status: 'Status: Black Spot Detected',
                statusColor: '#ef4444',
                description: 'Black spot is a common fungal disease affecting rose bushes. It is characterized by black spots on the leaves, which often turn yellow and fall off, weakening the plant.',
                solution: 'Prune and destroy infected leaves and stems to prevent the spread of spores. Apply a fungicide specifically for black spot. Water the plant at the base to keep foliage dry and avoid overhead irrigation.',
                imageSrc: 'https://placehold.co/400x300/EBF4F5/6B7280?text=Rose+Black+Spot'
            }
        };

        const navigateTo = (pageId, data = {}) => {
            for (let page in pages) {
                pages[page].classList.remove('active');
            }
            pages[pageId].classList.add('active');
            
            closeMenu();

            // Handle header menu button visibility
            if (pageId === 'welcome' || pageId === 'login' || pageId === 'signup') {
                menuBtn.classList.add('hidden');
            } else {
                menuBtn.classList.remove('hidden');
            }

            // Handle footer visibility
            if (pageId === 'main' || pageId === 'historyDetail' || pageId === 'kbDetail') {
                footer.classList.add('active');
            } else {
                footer.classList.remove('active');
            }
        };

        const switchTab = (tabId) => {
            for (let tab in tabs) {
                tabs[tab].classList.add('hidden');
                footerTabs[tab].classList.remove('active');
            }
            tabs[tabId].classList.remove('hidden');
            footerTabs[tabId].classList.add('active');
        };

        const showKnowledgeBaseDetail = (topic) => {
            const data = kbData[topic];
            document.getElementById('kbDetailTitle').textContent = data.title;
            document.getElementById('kbDetailDescription').textContent = data.description;
            document.getElementById('kbDetailCauses').textContent = data.causes;
            document.getElementById('kbDetailSolutions').textContent = data.solutions;
            navigateTo('kbDetail');
        };

        const showHistoryDetail = (id) => {
            const data = historyData[id];
            document.getElementById('historyTitle').textContent = data.title;
            document.getElementById('historyStatus').textContent = data.status;
            document.getElementById('historyStatus').style.color = data.statusColor;
            document.getElementById('historyDescription').textContent = data.description;
            document.getElementById('historySolution').textContent = data.solution;
            document.getElementById('historyImage').src = data.imageSrc;
            navigateTo('historyDetail');
        };

        const showLoading = () => {
            document.getElementById('resultImage').classList.add('hidden');
            document.getElementById('resultContent').classList.add('hidden');
            document.getElementById('goHomeBtn').classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
        };

        const showResult = (data) => {
            loadingSpinner.classList.add('hidden');
            document.getElementById('resultImage').classList.remove('hidden');
            document.getElementById('resultContent').classList.remove('hidden');
            document.getElementById('goHomeBtn').classList.remove('hidden');

            document.getElementById('resultCropName').textContent = data.cropName;
            document.getElementById('resultHealthStatus').textContent = data.healthStatus;
            document.getElementById('resultConfidence').textContent = data.confidence;
            document.getElementById('resultImage').src = data.imageSrc;

            const populateList = (listId, items) => {
                const listElement = document.getElementById(listId);
                listElement.innerHTML = '';
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    listElement.appendChild(li);
                });
            };

            populateList('resultIssuesList', data.possibleIssues);
            populateList('resultReasonsList', data.reasons);
            populateList('resultActionsList', data.suggestedActions);
            populateList('resultTipsList', data.preventionTips);
        };
        
        async function diagnosePlantWithGemini(base64ImageData) {
            const prompt = `Analyze this image of a plant leaf for any diseases or issues.
                                Provide a detailed diagnosis including the crop name, health status, confidence score, possible issues, reasons for the issues, suggested actions, and prevention tips for the future.
                                If the plant is healthy, state that.
                                Format your response as a JSON object with the following keys, and provide the output in Hindi language with easy to understand words:
                                "cropName", "healthStatus", "confidence in percentage",
                                "possibleIssues" (an array of strings),
                                "reasons" (an array of strings),
                                "suggestedActions" (an array of strings),
                                "preventionTips" (an array of strings).`;

            let retryCount = 0;
            const maxRetries = 3;
            const initialDelay = 1000;

            while (retryCount < maxRetries) {
                try {
                    const payload = {
                        contents: [
                            {
                                role: "user",
                                parts: [
                                    { text: prompt },
                                    {
                                        inlineData: {
                                            mimeType: "image/jpeg",
                                            data: base64ImageData
                                        }
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "cropName": { "type": "STRING" },
                                    "healthStatus": { "type": "STRING" },
                                    "confidence": { "type": "STRING" },
                                    "possibleIssues": { "type": "ARRAY", "items": { "type": "STRING" } },
                                    "reasons": { "type": "ARRAY", "items": { "type": "STRING" } },
                                    "suggestedActions": { "type": "ARRAY", "items": { "type": "STRING" } },
                                    "preventionTips": { "type": "ARRAY", "items": { "type": "STRING" } }
                                }
                            }
                        }
                    };

                    const apiKey = "AIzaSyBtXzhyelOsCbeRuERdt88AuQPQUkYEn44";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonText = result.candidates[0].content.parts[0].text;
                            const parsedJson = JSON.parse(jsonText);
                            return parsedJson;
                        } else {
                            throw new Error("Invalid response structure from Gemini API");
                        }
                    } else if (response.status === 429) {
                        const delay = initialDelay * Math.pow(2, retryCount);
                        await new Promise(res => setTimeout(res, delay));
                        retryCount++;
                    } else {
                        throw new Error(`API error: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Error during Gemini API call:", error);
                    return {
                        cropName: 'Diagnosis Failed',
                        healthStatus: 'Status: Error',
                        confidence: '0%',
                        possibleIssues: ['An error occurred while trying to diagnose your plant.'],
                        reasons: ['Please try again.'],
                        suggestedActions: ['Ensure the image is clear and of a single plant leaf.'],
                        preventionTips: ['Check your network connection.']
                    };
                }
            }
            
            return {
                cropName: 'Diagnosis Failed',
                healthStatus: 'Status: Timeout',
                confidence: '0%',
                possibleIssues: ['The diagnosis request timed out.'],
                reasons: ['Please try again later.'],
                suggestedActions: ['Ensure you have a stable network connection and try again.'],
                preventionTips: ['']
            };
        }

        async function readAloudWithGemini(text) {
            try {
                const payload = {
                    contents: [{
                        parts: [{ text: text }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Puck" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const apiKey = "AIzaSyBtXzhyelOsCbeRuERdt88AuQPQUkYEn44";
                const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const base64ToArrayBuffer = (base64) => {
                        const binaryString = window.atob(base64);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        return bytes.buffer;
                    };

                    const pcmData = base64ToArrayBuffer(audioData);
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    
                    const pcm16 = new Int16Array(pcmData);
                    const float32 = new Float32Array(pcm16.length);
                    for (let i = 0; i < pcm16.length; i++) {
                        float32[i] = pcm16[i] / 32768;
                    }

                    const audioBuffer = audioCtx.createBuffer(1, float32.length, audioCtx.sampleRate);
                    audioBuffer.copyToChannel(float32, 0);

                    const source = audioCtx.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioCtx.destination);
                    source.start();
                    
                    const readAloudBtn = document.getElementById('readAloudBtn');
                    readAloudBtn.classList.add('bg-gray-400');
                    readAloudBtn.classList.remove('bg-blue-500');
                    readAloudBtn.disabled = true;

                    source.onended = () => {
                        readAloudBtn.classList.remove('bg-gray-400');
                        readAloudBtn.classList.add('bg-blue-500');
                        readAloudBtn.disabled = false;
                    };
                }
            } catch (error) {
                console.error("Error with TTS:", error);
            }
        }

        // Initial Navigation
        navigateTo('welcome');

        // Event Listeners for Navigation
        appLogo.addEventListener('click', () => {
            if (!pages.welcome.classList.contains('active') && !pages.login.classList.contains('active') && !pages.signup.classList.contains('active')) {
                navigateTo('main');
                switchTab('dashboard');
            }
        });
        document.getElementById('getStartedBtn').addEventListener('click', () => {
            navigateTo('login');
        });

        // VALIDATION LOGIC UPDATED HERE
        document.getElementById('loginBtn').addEventListener('click', () => {
            const mobile = document.getElementById('loginMobile').value;
            const password = document.getElementById('loginPassword').value;

            if (mobile.length !== 10) {
                alert("Please provide a valid mobile number.");
            } else if (password.length < 6) {
                alert("Invalid Password.");
            } else {
                navigateTo('main');
                switchTab('dashboard');
            }
        });

        document.getElementById('signupBtn').addEventListener('click', () => {
            const name = document.getElementById('signupName').value;
            const mobile = document.getElementById('signupMobile').value;
            const password = document.getElementById('signupPassword').value;

            if (name === "") {
                alert("Full Name is required.");
            } else if (mobile.length !== 10) {
                alert("Please provide a valid mobile number.");
            } else if (password.length < 6) {
                alert("Create a Strong Password.");
            } else {
                navigateTo('main');
                switchTab('dashboard');
            }
        });
        // END OF UPDATED VALIDATION LOGIC
        
        document.getElementById('toSignupLink').addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo('signup');
        });

        document.getElementById('toLoginLink').addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo('login');
        });

        // Event listeners for new menu
        function toggleMenu() {
            sidebarMenu.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        }
        function closeMenu() {
            sidebarMenu.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }
        menuBtn.addEventListener('click', toggleMenu);
        closeMenuBtn.addEventListener('click', closeMenu);
        sidebarOverlay.addEventListener('click', closeMenu);

        // Menu navigation
        document.getElementById('weatherMenuBtn').addEventListener('click', () => {
            navigateTo('weather');
            fetchWeatherData();
        });
        document.getElementById('profileMenuBtn').addEventListener('click', () => {
            navigateTo('profile');
        });
        document.getElementById('logoutMenuBtn').addEventListener('click', () => {
            navigateTo('login');
        });
        document.getElementById('marketMenuBtn').addEventListener('click', () => {
            navigateTo('market');
            fetchLiveMarketPrices();
        });
        document.getElementById('chatbotMenuBtn').addEventListener('click', () => {
            navigateTo('chatbot');
        });

        document.getElementById('goHomeBtn').addEventListener('click', () => {
            navigateTo('main');
            switchTab('dashboard');
        });

        // Event listeners for footer buttons
        footerTabs.dashboard.addEventListener('click', () => {
            navigateTo('main');
            switchTab('dashboard');
        });
        footerTabs.history.addEventListener('click', () => {
            navigateTo('main');
            switchTab('history');
        });
        footerTabs.kb.addEventListener('click', () => {
            navigateTo('main');
            switchTab('kb');
        });

        // Event listeners for Knowledge Base items
        document.getElementById('kbList').addEventListener('click', (event) => {
            const listItem = event.target.closest('.kb-item');
            if (listItem) {
                const topic = listItem.dataset.topic;
                showKnowledgeBaseDetail(topic);
            }
        });

        // Event listeners for History items
        document.getElementById('historyList').addEventListener('click', (event) => {
            const listItem = event.target.closest('.history-item');
            if (listItem) {
                const id = listItem.dataset.historyId;
                showHistoryDetail(id);
            }
        });

        // Event listener for the "Back" button on the KB detail page
        document.getElementById('kbBackBtn').addEventListener('click', () => {
            navigateTo('main');
            switchTab('kb');
        });
        
        // Event listener for the "Read Aloud" button on the KB detail page
        document.getElementById('readAloudBtn').addEventListener('click', () => {
            const textToSpeak = `
                ${document.getElementById('kbDetailTitle').textContent}.
                ${document.getElementById('kbDetailDescription').textContent}.
                Causes: ${document.getElementById('kbDetailCauses').textContent}.
                Solutions: ${document.getElementById('kbDetailSolutions').textContent}.
            `;
            readAloudWithGemini(textToSpeak);
        });

        // Event listener for the "Back" button on the History detail page
        document.getElementById('historyBackBtn').addEventListener('click', () => {
            navigateTo('main');
            switchTab('history');
        });

        // Handle Image Upload and real Diagnosis
        document.getElementById('imageUploadInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64ImageData = e.target.result.split(',')[1];
                
                navigateTo('result');
                showLoading();

                const diagnosisData = await diagnosePlantWithGemini(base64ImageData);
                
                diagnosisData.imageSrc = e.target.result;
                showResult(diagnosisData);
            };
            reader.readAsDataURL(file);
        });

        // NEW: Video Processing and Diagnosis
        async function processVideoFile(file) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.preload = 'metadata';

                video.onloadedmetadata = () => {
                    // Set video playback to a specific point to get a good frame
                    video.currentTime = Math.min(video.duration / 2, 5); // Use a frame from the middle or at 5 seconds, whichever is shorter
                    
                    video.onseeked = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        const base64ImageData = canvas.toDataURL('image/jpeg').split(',')[1];
                        resolve(base64ImageData);
                    };
                    video.play(); // Play to trigger a seek event on some browsers
                };
                
                video.onerror = (e) => {
                    reject("Error loading video file.");
                };
                
                const fileURL = URL.createObjectURL(file);
                video.src = fileURL;
            });
        }
        
        document.getElementById('videoUploadInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            navigateTo('result');
            showLoading();

            try {
                const base64ImageData = await processVideoFile(file);
                const diagnosisData = await diagnosePlantWithGemini(base64ImageData);
                
                // You can't use the video as the image source, so we'll use a placeholder or a default
                diagnosisData.imageSrc = URL.createObjectURL(file); 
                showResult(diagnosisData);

            } catch (error) {
                console.error("Video processing error:", error);
                const diagnosisData = {
                    cropName: 'Diagnosis Failed',
                    healthStatus: 'Status: Video Error',
                    confidence: '0%',
                    possibleIssues: ['Could not process the video file.'],
                    reasons: ['The file format may not be supported or the video is corrupted.'],
                    suggestedActions: ['Please try again with a different video file or use the image upload feature.'],
                    preventionTips: ['Ensure the video is in a common format like MP4.']
                };
                diagnosisData.imageSrc = ''; // No image to display
                showResult(diagnosisData);
            }
        });
        
        // --- WEATHER FEATURE CODE ---
        let weatherDataFetched = false;
        const WEATHER_API_KEY = 'your_open_weather_api_key'; // Replace with a real API key
        const WEATHER_LOCATION = 'Jabalpur,IN'; // Hardcoded for this example

        async function fetchWeatherData() {
            if (weatherDataFetched) return; // Only fetch once per session
            
            const weatherTempEl = document.getElementById('weatherTemp');
            const weatherConditionEl = document.getElementById('weatherCondition');
            const weatherIconEl = document.getElementById('weatherIcon');
            const weatherAdvisoryEl = document.getElementById('weatherAdvisory');
            const weatherLocationEl = document.getElementById('weatherLocation');

            weatherTempEl.textContent = '--¬∞C';
            weatherConditionEl.textContent = 'Loading...';
            weatherIconEl.src = '';
            weatherAdvisoryEl.textContent = 'Loading weather data...';
            weatherLocationEl.textContent = 'Loading Weather for your location...';

            if (WEATHER_API_KEY === 'your_open_weather_api_key') {
                updateWeatherUI({
                    temp: 35,
                    condition: 'Hazy',
                    icon: '50d',
                    location: 'Jabalpur'
                });
                updateWeatherAdvisory('High temperatures and haze. Consider watering plants early in the morning or late evening to prevent moisture loss.');
                weatherDataFetched = true;
                return;
            }
            try {
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${WEATHER_LOCATION}&appid=${WEATHER_API_KEY}&units=metric`);
                const data = await response.json();
                
                if (response.ok) {
                    const weatherData = {
                        temp: Math.round(data.main.temp),
                        condition: data.weather[0].description,
                        icon: data.weather[0].icon,
                        location: data.name
                    };
                    updateWeatherUI(weatherData);
                    updateWeatherAdvisory(generateAdvisory(weatherData));
                    weatherDataFetched = true;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error("Error fetching weather data:", error);
                updateWeatherUI({
                    temp: '--',
                    condition: 'Error',
                    icon: '',
                    location: 'Failed to fetch location'
                });
                updateWeatherAdvisory('Could not fetch weather data. Please check your network connection.');
            }
        }
        
        function updateWeatherUI(data) {
            document.getElementById('weatherTemp').textContent = `${data.temp}¬∞C`;
            document.getElementById('weatherCondition').textContent = data.condition.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            document.getElementById('weatherIcon').src = `http://openweathermap.org/img/wn/${data.icon}@2x.png`;
            document.getElementById('weatherLocation').textContent = `Weather in ${data.location}`;
        }
        
        function updateWeatherAdvisory(advisory) {
            document.getElementById('weatherAdvisory').textContent = advisory;
        }

        function generateAdvisory(weatherData) {
            const temp = weatherData.temp;
            const condition = weatherData.condition.toLowerCase();

            if (condition.includes('rain')) {
                return "Rain expected today. Ensure proper drainage in fields to prevent waterlogging.";
            }
            if (temp > 35) {
                return "High temperatures expected. Water your plants early in the morning to prevent wilting and moisture loss.";
            }
            if (temp < 10) {
                return "Cold weather alert. Protect sensitive crops from frost by covering them or using sprinklers.";
            }
            if (condition.includes('sunny')) {
                return "Perfect conditions for growth. Ensure regular watering and check for any pests.";
            }
            if (condition.includes('haze') || condition.includes('smoke')) {
                return "Hazy conditions. Monitor air quality and its impact on plant photosynthesis.";
            }
            return "Stable weather conditions. Continue with routine farming practices.";
        }
        
        // --- END OF WEATHER FEATURE CODE ---

        // --- UPDATED LIVE MARKET FEATURE CODE WITH FALLBACK ---

        // Dummy data for fallback
        const DUMMY_MARKET_DATA = [
            { commodity: 'Wheat (‡§ó‡•á‡§π‡•Ç‡§Å)', price: '‚Çπ2,500/quintal', market: 'Amritsar Mandi', updatedOn: 'Today, 10:30 AM' },
            { commodity: 'Paddy (‡§ß‡§æ‡§®)', price: '‚Çπ2,200/quintal', market: 'Ludhiana Mandi', updatedOn: 'Today, 11:15 AM' },
            { commodity: 'Potato (‡§Ü‡§≤‡•Ç)', price: '‚Çπ1,500/quintal', market: 'Jalandhar Mandi', updatedOn: 'Today, 11:00 AM' },
            { commodity: 'Cotton (‡§ï‡§™‡§æ‡§∏)', price: '‚Çπ7,500/quintal', market: 'Bathinda Mandi', updatedOn: 'Yesterday, 04:00 PM' },
            { commodity: 'Maize (‡§Æ‡§ï‡•ç‡§ï‡§æ)', price: '‚Çπ2,000/quintal', market: 'Patiala Mandi', updatedOn: 'Today, 09:45 AM' }
        ];

        // Replace with your Agmarknet API key
        const AGMARKNET_API_KEY = "YOUR_AGMARKNET_API_KEY_HERE"; 
        
        async function fetchLiveMarketPrices() {
            const listEl = document.getElementById('marketPricesList');
            const marketStatusEl = document.getElementById('marketStatus');

            // Show a loading state
            listEl.innerHTML = ''; // Clear previous data
            marketStatusEl.textContent = 'Fetching live data...';
            listEl.innerHTML = `<p class="text-center text-gray-500 flex flex-col items-center"><div class="loader mb-4"></div> Loading live prices...</p>`;

            const API_URL = `https://api.example.com/agmarknet/prices?key=${AGMARKNET_API_KEY}&state=Jabalpur&date=2025-09-09`; // Example URL

            try {
                // Check if API key is provided
                if (AGMARKNET_API_KEY === "YOUR_AGMARKNET_API_KEY_HERE") {
                    throw new Error("API Key is missing. Using dummy data.");
                }

                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Check if the API returned valid data
                if (data && data.prices && data.prices.length > 0) {
                    // Success: Display live data
                    populateMarketList(data.prices);
                    marketStatusEl.textContent = 'Live data from Agmarknet.';
                } else {
                    // No data found in API response
                    throw new Error("No live data available for this location.");
                }
            } catch (error) {
                console.error("Error fetching live market data:", error);
                
                // Fallback: Display dummy data
                populateMarketList(DUMMY_MARKET_DATA, true);
                marketStatusEl.textContent = 'Could not fetch live data. Displaying sample data.';
            }
        }
        
        function populateMarketList(data, isDummy = false) {
            const listEl = document.getElementById('marketPricesList');
            listEl.innerHTML = ''; // Clear loading spinner or old data
            
            data.forEach(item => {
                const li = document.createElement('li');
                li.className = 'bg-white rounded-lg p-4 shadow-sm';
                li.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <p class="text-lg font-bold text-green-700">${item.commodity}</p>
                        <p class="text-xl font-bold text-gray-800">${item.price}</p>
                    </div>
                    <p class="text-sm text-gray-500">${item.market}</p>
                    <p class="text-xs text-gray-400">Updated: ${item.updatedOn}</p>
                `;
                listEl.appendChild(li);
            });
            
            if (isDummy) {
                listEl.innerHTML += `<p class="text-center text-sm text-red-500 mt-4">Note: This is simulated data for demonstration.</p>`;
            }
        }
        // --- END OF UPDATED LIVE MARKET FEATURE CODE ---

        // --- NEW CHATBOT FEATURE CODE ---
        const CHATBOT_API_KEY = "AIzaSyBtXzhyelOsCbeRuERdt88AuQPQUkYEn44";
        const chatbox = document.getElementById('chatbox');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        let isTyping = false;

        async function sendQueryToGemini(query) {
            if (isTyping) return;
            isTyping = true;
            
            // Add user message to chatbox
            appendMessage(query, 'user');
            
            // Add bot's "typing" message
            const botMessageEl = appendMessage('...', 'bot');

            const prompt = `You are an expert Indian agricultural assistant named Agro-Assistant. Your task is to provide helpful, accurate, and simple advice to Indian farmers. Respond in easy-to-understand Hindi, but use Devanagari script for the text. Keep your answers concise and direct. If a question is not related to farming, politely redirect them to a farming topic. Use the user's name, Ramu Kaka, if possible.
            
            User's query: ${query}`;
            
            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${CHATBOT_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                // Update bot's message with the response
                if (text) {
                    botMessageEl.textContent = text;
                } else {
                    botMessageEl.textContent = "‡§Æ‡§æ‡•û ‡§ï‡•Ä‡§ú‡§ø‡§è, ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•á ‡§∏‡§µ‡§æ‡§≤ ‡§ï‡§æ ‡§ú‡§µ‡§æ‡§¨ ‡§®‡§π‡•Ä‡§Ç ‡§¶‡•á ‡§™‡§æ‡§Ø‡§æ‡•§";
                }
            } catch (error) {
                console.error("Chatbot API Error:", error);
                botMessageEl.textContent = "‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§∞‡§æ‡§Æ‡•Ç ‡§ï‡§æ‡§ï‡§æ‡•§ ‡§ï‡•Å‡§õ ‡§§‡§ï‡§®‡•Ä‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§¶‡•á‡§∞ ‡§¨‡§æ‡§¶ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§";
            } finally {
                isTyping = false;
                chatbox.scrollTop = chatbox.scrollHeight; // Auto-scroll to the bottom
            }
        }

        function appendMessage(text, sender) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-message', sender);
            messageEl.textContent = text;
            chatbox.appendChild(messageEl);
            chatbox.scrollTop = chatbox.scrollHeight;
            return messageEl;
        }
        
        sendBtn.addEventListener('click', () => {
            const query = chatInput.value.trim();
            if (query) {
                sendQueryToGemini(query);
                chatInput.value = '';
            }
        });

        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendBtn.click();
            }
        });
        // --- END OF NEW CHATBOT FEATURE CODE ---
    });

    // Register the Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
</script>

</body>
</html>