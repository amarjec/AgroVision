<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroVision App</title>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.3s ease;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page {
            display: none;
            padding: 2rem 1rem;
            max-width: 600px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease-in-out;
            box-sizing: border-box;
            flex-grow: 1;
            overflow-y: auto;
            width: 100%;
            overflow: hidden;
        }

        .page.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glass-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            padding: 2.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .main-button {
            background-color: #22c55e;
            color: white;
            padding: 1rem 2rem;
            border-radius: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 6px 10px rgba(0, 0, 0, 0.15);
        }

        input[type="file"] {
            display: none;
        }

        .nav-button {
            background-color: #f3f4f6;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
        }

        .nav-button:hover {
            background-color: #e5e7eb;
        }

        .nav-button.active {
            background-color: #d1fae5;
            color: #16a34a;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .history-item, .kb-item {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
        }

        .history-item:last-child, .kb-item:last-child {
            border-bottom: none;
        }

        .history-item-thumb, .kb-item-thumb {
            width: 4rem;
            height: 4rem;
            border-radius: 0.75rem;
            object-fit: cover;
            margin-right: 1rem;
        }

        .result-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 1.5rem;
            margin-bottom: 2rem;
        }

        .kb-list {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .kb-item:hover {
            background-color: #f9fafb;
        }

        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: #f3f4f6;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: white;
            padding: 1rem;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
            display: none; /* Hide by default */
            justify-content: space-between;
            align-items: center;
        }
        
        .fixed-footer.active {
            display: flex;
        }

        .content-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-top: 5rem;
            padding-bottom: 5rem;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #22c55e;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<!-- Fixed Header for All Pages -->
<header class="fixed-header">
    <nav class="w-full max-w-lg flex justify-between items-center px-4">
        <h1 id="appLogo" class="text-2xl font-bold text-gray-800 cursor-pointer">AgroVision</h1>
        <button id="headerProfileBtn" class="nav-button hidden">Profile</button>
    </nav>
</header>

<div class="content-container">
    <!-- Welcome Screen -->
    <div id="welcomePage" class="page active">
        <div class="flex flex-col items-center justify-center p-8 bg-white/80 backdrop-blur-md rounded-[2rem] shadow-xl">
            <img src="logo.jpeg" class="max-w-78" alt="">
            <!-- <h1 class="text-4xl font-bold text-gray-800 mb-4">üå± AgroVision</h1> -->
            <p class="text-lg text-gray-600 mb-8 max-w-sm text-center">Your pocket guide to diagnosing plant health and finding solutions.</p>
            <button id="getStartedBtn" class="main-button">Get Started</button>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="page">
        <div class="glass-card w-full flex flex-col items-center ">
            <img src="logo.jpeg" class="max-w-44" alt="">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Login</h1>
            <div class="space-y-4">
                <input type="tel" placeholder="Mobile Number" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-green-500">
                <input type="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-green-500">
                <button id="loginBtn" class="main-button w-full">Login</button>
            </div>
            <p class="mt-4 text-gray-600">Don't have an account? <a href="#" id="toSignupLink" class="text-green-500 font-semibold hover:underline">Sign Up</a></p>
        </div>
    </div>

    <!-- Sign-up Page -->
    <div id="signupPage" class="page">
        <div class="glass-card w-full flex flex-col items-center ">
            <img src="logo.jpeg" class="max-w-44" alt="">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Sign Up</h1>
            <div class="space-y-4">
                <input type="text" placeholder="Full Name" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-green-500">
                <input type="tel" placeholder="Mobile Number" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-green-500">
                <input type="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:outline-none focus:border-green-500">
                <button id="signupBtn" class="main-button w-full">Sign Up</button>
            </div>
            <p class="mt-4 text-gray-600">Already have an account? <a href="#" id="toLoginLink" class="text-green-500 font-semibold hover:underline">Login</a></p>
        </div>
    </div>

    <!-- Main Content Pages -->
    <div id="mainPage" class="page">
        <!-- Dashboard Page -->
        <div id="dashboardContent" class="w-full flex flex-col items-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2 mt-4">Hi, Ramu Kaka! üëã</h2>
            <p class="text-lg text-gray-600 mb-8">Ready to check on your plants?</p>
            
            <div class="glass-card w-full mb-6">
                <h3 class="text-2xl font-semibold text-gray-700 mb-6">Diagnose a Plant</h3>
                <p class="text-gray-500 mb-8">Take a clear picture of a leaf to get a diagnosis.</p>
                <label for="imageUploadInput" class="main-button cursor-pointer">
                    Upload Image
                </label>
            </div>
            <input type="file" id="imageUploadInput" accept="image/*">

            <div class="bg-white/70 backdrop-blur-md rounded-[1.5rem] shadow-lg p-6 w-full mb-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Your Recent Diagnosis</h3>
                <ul class="history-list" id="dashboardHistoryList">
                    <li class="history-item" data-history-id="tomatoHealthy">
                        <img src="https://placehold.co/64x64/EBF4F5/6B7280?text=Leaf" alt="Tomato Leaf" class="history-item-thumb">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Tomato Plant - Healthy</p>
                            <p class="text-sm text-gray-500">2 days ago</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Diagnosis History Page -->
        <div id="historyContent" class="hidden w-full flex flex-col items-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 mt-4">Diagnosis History</h1>
            <div class="bg-white/70 backdrop-blur-md rounded-[1.5rem] shadow-lg p-6 w-full">
                <ul class="history-list" id="historyList">
                    <li class="history-item" data-history-id="tomatoHealthy">
                        <img src="https://placehold.co/64x64/EBF4F5/6B7280?text=Leaf" alt="Tomato Leaf" class="history-item-thumb">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Tomato Plant - Healthy</p>
                            <p class="text-sm text-gray-500">2 days ago</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                    <li class="history-item" data-history-id="potatoBlight">
                        <img src="https://placehold.co/64x64/EBF4F5/6B7280?text=Leaf" alt="Potato Leaf" class="history-item-thumb">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Potato Plant - Blight</p>
                            <p class="text-sm text-gray-500">5 days ago</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                    <li class="history-item" data-history-id="roseBlackSpot">
                        <img src="https://placehold.co/64x64/EBF4F5/6B7280?text=Leaf" alt="Rose Leaf" class="history-item-thumb">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Rose Bush - Black Spot</p>
                            <p class="text-sm text-gray-500">1 week ago</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Knowledge Base Page -->
        <div id="kbContent" class="hidden w-full flex flex-col items-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 mt-4">Plantpedia</h1>
            <div class="bg-white/70 backdrop-blur-md rounded-[1.5rem] shadow-lg p-6 w-full">
                <ul class="kb-list" id="kbList">
                    <li class="kb-item" data-topic="aphids">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Aphids</p>
                            <p class="text-sm text-gray-500">Common Pests</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                    <li class="kb-item" data-topic="powderyMildew">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Powdery Mildew</p>
                            <p class="text-sm text-gray-500">Fungal Disease</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                    <li class="kb-item" data-topic="nitrogenDeficiency">
                        <div class="flex-grow">
                            <p class="text-gray-800 font-medium">Nitrogen Deficiency</p>
                            <p class="text-sm text-gray-500">Nutrient Deficiency</p>
                        </div>
                        <div class="ml-auto text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- New: Knowledge Base Detail Page -->
    <div id="kbDetailPage" class="page">
        <button id="kbBackBtn" class="self-start mb-4 px-4 py-2 bg-gray-200 text-gray-700 rounded-full font-semibold transition-colors duration-200 hover:bg-gray-300">
            &larr; Back
        </button>
        <div class="glass-card w-full">
            <h1 id="kbDetailTitle" class="text-3xl font-bold text-gray-800 mb-4"></h1>
            <p id="kbDetailDescription" class="text-gray-600 text-sm leading-relaxed mb-6 text-left"></p>
            <h2 class="text-xl font-bold text-gray-800 mb-2 text-left">Causes</h2>
            <p id="kbDetailCauses" class="text-gray-600 text-sm leading-relaxed mb-6 text-left"></p>
            <h2 class="text-xl font-bold text-gray-800 mb-2 text-left">Solutions</h2>
            <p id="kbDetailSolutions" class="text-gray-600 text-sm leading-relaxed text-left"></p>
            <div class="flex justify-center mt-6">
                <button id="readAloudBtn" class="flex items-center px-6 py-3 bg-blue-500 text-white rounded-full font-semibold hover:bg-blue-600 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L6.683 15H2a1 1 0 01-1-1V6a1 1 0 011-1h4.683l2.618-2.618a1 1 0 011.082-.306zM15.536 6.757a.75.75 0 011.06 1.06l-1.06 1.06.53.53a.75.75 0 01-1.06 1.06l-.53-.53-1.06 1.06a.75.75 0 01-1.06-1.06l1.06-1.06-.53-.53a.75.75 0 011.06-1.06l.53.53 1.06-1.06z" clip-rule="evenodd" />
                    </svg>
                    <span>Read Aloud ‚ú®</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- New: History Detail Page -->
    <div id="historyDetailPage" class="page">
        <button id="historyBackBtn" class="self-start mb-4 px-4 py-2 bg-gray-200 text-gray-700 rounded-full font-semibold transition-colors duration-200 hover:bg-gray-300">
            &larr; Back
        </button>
        <div class="glass-card w-full">
            <img id="historyImage" src="" alt="Diagnosed Leaf" class="result-image">
            <h2 id="historyTitle" class="text-3xl font-semibold text-gray-700 mb-2"></h2>
            <p id="historyStatus" class="text-xl font-medium mb-4"></p>
            <p id="historyDescription" class="text-gray-600 text-sm leading-relaxed mb-6 text-left"></p>
            <p id="historySolution" class="text-gray-600 text-sm leading-relaxed text-left"></p>
        </div>
    </div>

    <!-- Diagnosis Result Screen -->
    <div id="resultPage" class="page">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 mt-4">Diagnosis Result</h1>
        <div id="resultCard" class="glass-card w-full flex flex-col items-center">
            <!-- Loading spinner will be shown here during processing -->
            <div id="loading" class="hidden">
                <div class="loader mb-4"></div>
                <p class="text-gray-600">Analyzing plant... please wait.</p>
            </div>
            
            <img id="resultImage" src="" alt="Diagnosed Leaf" class="result-image hidden">
            <h2 id="resultTitle" class="text-3xl font-semibold text-gray-700 mb-2 hidden"></h2>
            <p id="resultStatus" class="text-xl font-medium mb-4 hidden"></p>
            <p id="resultDescription" class="text-gray-600 text-sm leading-relaxed mb-6 text-left hidden"></p>
            <p id="resultSolution" class="text-gray-600 text-sm leading-relaxed text-left hidden"></p>
            <button id="goHomeBtn" class="mt-8 px-8 py-3 bg-gray-200 text-gray-700 rounded-full font-semibold transition-colors duration-200 hover:bg-gray-300 hidden">
                Go Home
            </button>
        </div>
    </div>

    <!-- Profile Page -->
    <div id="profilePage" class="page">
        <div class="glass-card w-full">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">User Profile</h1>
            <div class="flex flex-col items-center space-y-4 mb-8">
                <img src="https://placehold.co/128x128/EBF4F5/6B7280?text=Farmer" alt="User Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800">Ramu Kaka</h2>
                <p class="text-gray-500 text-sm">Farmer from Punjab, India</p>
            </div>
            <div class="space-y-4 text-left w-full">
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500">üì±</span>
                    <p class="text-gray-600"><span class="font-semibold text-gray-800">Mobile No:</span> +91 98765 43210</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500">üìç</span>
                    <p class="text-gray-600"><span class="font-semibold text-gray-800">Location:</span> Punjab, India</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500">üìÖ</span>
                    <p class="text-gray-600"><span class="font-semibold text-gray-800">Member Since:</span> January 2023</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-500">üìä</span>
                    <p class="text-gray-600"><span class="font-semibold text-gray-800">Total Diagnoses:</span> 42</p>
                </div>
            </div>
            <button id="logoutBtn" class="mt-8 px-8 py-3 bg-red-500 text-white rounded-full font-semibold transition-colors duration-200 hover:bg-red-600">
                Logout
            </button>
        </div>
    </div>
</div>

<!-- Fixed Footer with tabs -->
<footer id="footer" class="fixed-footer">
    <button id="homeTabBtn" class="nav-button active">Dashboard</button>
    <button id="historyTabBtn" class="nav-button">History</button>
    <button id="kbTabBtn" class="nav-button">Plantpedia</button>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const pages = {
            welcome: document.getElementById('welcomePage'),
            login: document.getElementById('loginPage'),
            signup: document.getElementById('signupPage'),
            main: document.getElementById('mainPage'),
            result: document.getElementById('resultPage'),
            profile: document.getElementById('profilePage'),
            kbDetail: document.getElementById('kbDetailPage'),
            historyDetail: document.getElementById('historyDetailPage')
        };
        const tabs = {
            dashboard: document.getElementById('dashboardContent'),
            history: document.getElementById('historyContent'),
            kb: document.getElementById('kbContent')
        };
        const footerTabs = {
            dashboard: document.getElementById('homeTabBtn'),
            history: document.getElementById('historyTabBtn'),
            kb: document.getElementById('kbTabBtn')
        };
        const footer = document.getElementById('footer');
        const headerProfileBtn = document.getElementById('headerProfileBtn');
        const appLogo = document.getElementById('appLogo');
        const loadingSpinner = document.getElementById('loading');
        const resultCard = document.getElementById('resultCard');

        // Data for Knowledge Base details
        const kbData = {
            aphids: {
                title: "Aphids",
                description: "Aphids are small, sap-sucking insects that can be green, black, brown, or pink. They are often found in clusters on the undersides of leaves and on new growth.",
                causes: "Aphid infestations typically occur when there is an imbalance in the ecosystem, such as a lack of natural predators like ladybugs. They can also be introduced from new plants or by wind.",
                solutions: "For a minor infestation, a strong spray of water from a hose can dislodge them. For a more severe problem, use insecticidal soap or neem oil. Encourage beneficial insects by planting flowers like marigolds and dill."
            },
            powderyMildew: {
                title: "Powdery Mildew",
                description: "Powdery mildew is a common fungal disease that appears as a white, powdery coating on the surface of leaves and stems. It can stunt growth and distort new leaves.",
                causes: "This fungus thrives in dry climates with high humidity. Overcrowded plants with poor air circulation are more susceptible, as are plants that are over-fertilized with high-nitrogen fertilizers.",
                solutions: "Prune affected leaves and stems to improve air circulation. Apply a fungicide, such as a mixture of baking soda and water or a commercial product. Avoid watering from overhead to keep foliage dry."
            },
            nitrogenDeficiency: {
                title: "Nitrogen Deficiency",
                description: "Nitrogen is a crucial nutrient for plant growth, particularly for developing healthy green foliage. A deficiency causes stunted growth and yellowing of older leaves, starting from the tips and moving inward.",
                causes: "Nitrogen deficiency is often caused by poor soil quality, leaching due to excessive watering, or a lack of organic matter. Sandy soils are particularly prone to this issue.",
                solutions: "Apply a balanced, slow-release fertilizer or a fertilizer high in nitrogen. Add organic matter like compost or aged manure to the soil. For a quick fix, use a liquid feed rich in nitrogen."
            }
        };

        // Added mock data for history entries
        const historyData = {
            tomatoHealthy: {
                title: 'Tomato Plant',
                status: 'Status: Healthy',
                statusColor: '#22c55e',
                description: 'This tomato plant appears to be in excellent health. The leaves are vibrant green and show no signs of common pests or fungal infections.',
                solution: 'Keep up the good work! Ensure the plant receives adequate sunlight (6-8 hours daily) and water it regularly, but avoid overwatering. Fertilize once a month during the growing season.',
                imageSrc: 'https://placehold.co/400x300/EBF4F5/6B7280?text=Healthy+Tomato'
            },
            potatoBlight: {
                title: 'Potato Plant',
                status: 'Status: Blight Detected',
                statusColor: '#ef4444',
                description: 'Late blight is a serious fungal disease caused by the oomycete Phytophthora infestans. It can affect all parts of the potato plant, with symptoms including dark, water-soaked spots on leaves and stems.',
                solution: 'Treatment is essential. Remove all infected leaves and stems immediately. Apply a fungicidal spray containing copper or mancozeb. Ensure proper air circulation by pruning the plant. Dispose of infected plant material responsibly to prevent spread.',
                imageSrc: 'https://placehold.co/400x300/EBF4F5/6B7280?text=Potato+Blight'
            },
            roseBlackSpot: {
                title: 'Rose Bush',
                status: 'Status: Black Spot Detected',
                statusColor: '#ef4444',
                description: 'Black spot is a common fungal disease affecting rose bushes. It is characterized by black spots on the leaves, which often turn yellow and fall off, weakening the plant.',
                solution: 'Prune and destroy infected leaves and stems to prevent the spread of spores. Apply a fungicide specifically for black spot. Water the plant at the base to keep foliage dry and avoid overhead irrigation.',
                imageSrc: 'https://placehold.co/400x300/EBF4F5/6B7280?text=Rose+Black+Spot'
            }
        };

        const navigateTo = (pageId, data = {}) => {
            for (let page in pages) {
                pages[page].classList.remove('active');
            }
            pages[pageId].classList.add('active');

            // Handle header profile button visibility
            if (pageId === 'welcome' || pageId === 'login' || pageId === 'signup') {
                headerProfileBtn.classList.add('hidden');
            } else {
                headerProfileBtn.classList.remove('hidden');
            }

            // Handle footer visibility
            if (pageId === 'main' || pageId === 'historyDetail' || pageId === 'kbDetail') {
                footer.classList.add('active');
            } else {
                footer.classList.remove('active');
            }
            
            // Populate result page
            if (pageId === 'result') {
                const resultTitle = document.getElementById('resultTitle');
                const resultStatus = document.getElementById('resultStatus');
                const resultDescription = document.getElementById('resultDescription');
                const resultSolution = document.getElementById('resultSolution');
                const resultImage = document.getElementById('resultImage');

                resultImage.src = data.imageSrc;
                resultTitle.textContent = data.title;
                resultStatus.textContent = data.status;
                resultStatus.style.color = data.statusColor;
                resultDescription.textContent = data.description;
                resultSolution.textContent = data.solution;
            }
        };

        const switchTab = (tabId) => {
            for (let tab in tabs) {
                tabs[tab].classList.add('hidden');
                footerTabs[tab].classList.remove('active');
            }
            tabs[tabId].classList.remove('hidden');
            footerTabs[tabId].classList.add('active');
        };

        const showKnowledgeBaseDetail = (topic) => {
            const data = kbData[topic];
            document.getElementById('kbDetailTitle').textContent = data.title;
            document.getElementById('kbDetailDescription').textContent = data.description;
            document.getElementById('kbDetailCauses').textContent = data.causes;
            document.getElementById('kbDetailSolutions').textContent = data.solutions;
            navigateTo('kbDetail');
        };

        const showHistoryDetail = (id) => {
            const data = historyData[id];
            document.getElementById('historyTitle').textContent = data.title;
            document.getElementById('historyStatus').textContent = data.status;
            document.getElementById('historyStatus').style.color = data.statusColor;
            document.getElementById('historyDescription').textContent = data.description;
            document.getElementById('historySolution').textContent = data.solution;
            document.getElementById('historyImage').src = data.imageSrc;
            navigateTo('historyDetail');
        };

        // Function to handle showing the loading state
        const showLoading = () => {
            // Hide all result content and show loader
            document.getElementById('resultImage').classList.add('hidden');
            document.getElementById('resultTitle').classList.add('hidden');
            document.getElementById('resultStatus').classList.add('hidden');
            document.getElementById('resultDescription').classList.add('hidden');
            document.getElementById('resultSolution').classList.add('hidden');
            document.getElementById('goHomeBtn').classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
        };

        // Function to handle showing the result content
        const showResult = () => {
            loadingSpinner.classList.add('hidden');
            document.getElementById('resultImage').classList.remove('hidden');
            document.getElementById('resultTitle').classList.remove('hidden');
            document.getElementById('resultStatus').classList.remove('hidden');
            document.getElementById('resultDescription').classList.remove('hidden');
            document.getElementById('resultSolution').classList.remove('hidden');
            document.getElementById('goHomeBtn').classList.remove('hidden');
        };
        
        // Function to make the Gemini Vision API call for diagnosis
        async function diagnosePlantWithGemini(base64ImageData) {
            const prompt = `Analyze this image of a plant leaf for any diseases or issues.
                            Provide a diagnosis, a brief description of the condition, and a solution.
                            If the plant is healthy, state that.
                            Format your response as a JSON object with the following keys:
                            "title" (e.g., "Tomato Plant"), "status" (e.g., "Status: Healthy" or "Status: Late Blight Detected"),
                            "statusColor" (e.g., "#22c55e" for healthy, "#ef4444" for a problem),
                            "description", and "solution". in hindi language with easy to understand words.`;

            let retryCount = 0;
            const maxRetries = 3;
            const initialDelay = 1000; // 1 second

            while (retryCount < maxRetries) {
                try {
                    const payload = {
                        contents: [
                            {
                                role: "user",
                                parts: [
                                    { text: prompt },
                                    {
                                        inlineData: {
                                            mimeType: "image/jpeg",
                                            data: base64ImageData
                                        }
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "title": { "type": "STRING" },
                                    "status": { "type": "STRING" },
                                    "statusColor": { "type": "STRING" },
                                    "description": { "type": "STRING" },
                                    "solution": { "type": "STRING" }
                                },
                                "propertyOrdering": ["title", "status", "statusColor", "description", "solution"]
                            }
                        }
                    };

                    const apiKey = "AIzaSyBtXzhyelOsCbeRuERdt88AuQPQUkYEn44";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonText = result.candidates[0].content.parts[0].text;
                            const parsedJson = JSON.parse(jsonText);
                            return parsedJson;
                        } else {
                            throw new Error("Invalid response structure from Gemini API");
                        }
                    } else if (response.status === 429) {
                        // Too many requests, retry with exponential backoff
                        const delay = initialDelay * Math.pow(2, retryCount);
                        await new Promise(res => setTimeout(res, delay));
                        retryCount++;
                    } else {
                        throw new Error(`API error: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Error during Gemini API call:", error);
                    // For now, return a generic error response
                    return {
                        title: 'Diagnosis Failed',
                        status: 'Status: Error',
                        statusColor: '#ef4444',
                        description: 'An error occurred while trying to diagnose your plant. Please try again.',
                        solution: 'Ensure the image is clear and of a single plant leaf. Check your network connection.'
                    };
                }
            }
            
            // If all retries fail
            return {
                title: 'Diagnosis Failed',
                status: 'Status: Timeout',
                statusColor: '#ef4444',
                description: 'The diagnosis request timed out. Please try again later.',
                solution: 'Please ensure you have a stable network connection and try again.'
            };
        }

        // Function to make the Gemini TTS API call
        async function readAloudWithGemini(text) {
            try {
                const payload = {
                    contents: [{
                        parts: [{ text: text }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Puck" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                
                const apiKey = "AIzaSyBtXzhyelOsCbeRuERdt88AuQPQUkYEn44";
                const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    // Utility function to convert base64 to ArrayBuffer
                    const base64ToArrayBuffer = (base64) => {
                        const binaryString = window.atob(base64);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        return bytes.buffer;
                    };

                    const pcmData = base64ToArrayBuffer(audioData);
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // The API returns signed PCM16 audio data.
                    const pcm16 = new Int16Array(pcmData);
                    const float32 = new Float32Array(pcm16.length);
                    for (let i = 0; i < pcm16.length; i++) {
                        float32[i] = pcm16[i] / 32768; // Convert to float32
                    }

                    const audioBuffer = audioCtx.createBuffer(1, float32.length, audioCtx.sampleRate);
                    audioBuffer.copyToChannel(float32, 0);

                    const source = audioCtx.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioCtx.destination);
                    source.start();
                    
                    const readAloudBtn = document.getElementById('readAloudBtn');
                    readAloudBtn.classList.add('bg-gray-400');
                    readAloudBtn.classList.remove('bg-blue-500');
                    readAloudBtn.disabled = true;

                    source.onended = () => {
                        readAloudBtn.classList.remove('bg-gray-400');
                        readAloudBtn.classList.add('bg-blue-500');
                        readAloudBtn.disabled = false;
                    };
                }
            } catch (error) {
                console.error("Error with TTS:", error);
            }
        }

        // Initial Navigation
        navigateTo('welcome');

        // Event Listeners for Navigation
        appLogo.addEventListener('click', () => {
            if (!pages.welcome.classList.contains('active') && !pages.login.classList.contains('active') && !pages.signup.classList.contains('active')) {
                navigateTo('main');
                switchTab('dashboard');
            }
        });
        document.getElementById('getStartedBtn').addEventListener('click', () => {
            navigateTo('login');
        });

        document.getElementById('loginBtn').addEventListener('click', () => {
            navigateTo('main');
            switchTab('dashboard');
        });

        document.getElementById('signupBtn').addEventListener('click', () => {
            navigateTo('main');
            switchTab('dashboard');
        });
        
        document.getElementById('toSignupLink').addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo('signup');
        });

        document.getElementById('toLoginLink').addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo('login');
        });

        // Event listeners for profile and logout
        document.getElementById('headerProfileBtn').addEventListener('click', () => {
            navigateTo('profile');
        });
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            navigateTo('login');
        });

        document.getElementById('goHomeBtn').addEventListener('click', () => {
            navigateTo('main');
            switchTab('dashboard');
        });

        // Event listeners for footer buttons
        footerTabs.dashboard.addEventListener('click', () => {
            navigateTo('main');
            switchTab('dashboard');
        });
        footerTabs.history.addEventListener('click', () => {
            navigateTo('main');
            switchTab('history');
        });
        footerTabs.kb.addEventListener('click', () => {
            navigateTo('main');
            switchTab('kb');
        });

        // Event listeners for Knowledge Base items
        document.getElementById('kbList').addEventListener('click', (event) => {
            const listItem = event.target.closest('.kb-item');
            if (listItem) {
                const topic = listItem.dataset.topic;
                showKnowledgeBaseDetail(topic);
            }
        });

        // Event listeners for History items
        document.getElementById('historyList').addEventListener('click', (event) => {
            const listItem = event.target.closest('.history-item');
            if (listItem) {
                const id = listItem.dataset.historyId;
                showHistoryDetail(id);
            }
        });

        // Event listener for the "Back" button on the KB detail page
        document.getElementById('kbBackBtn').addEventListener('click', () => {
            navigateTo('main');
            switchTab('kb');
        });
        
        // Event listener for the "Read Aloud" button on the KB detail page
        document.getElementById('readAloudBtn').addEventListener('click', () => {
            const textToSpeak = `
                ${document.getElementById('kbDetailTitle').textContent}.
                ${document.getElementById('kbDetailDescription').textContent}.
                Causes: ${document.getElementById('kbDetailCauses').textContent}.
                Solutions: ${document.getElementById('kbDetailSolutions').textContent}.
            `;
            readAloudWithGemini(textToSpeak);
        });

        // Event listener for the "Back" button on the History detail page
        document.getElementById('historyBackBtn').addEventListener('click', () => {
            navigateTo('main');
            switchTab('history');
        });

        // Handle Image Upload and real Diagnosis
        document.getElementById('imageUploadInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64ImageData = e.target.result.split(',')[1];
                
                navigateTo('result');
                showLoading();

                const diagnosisData = await diagnosePlantWithGemini(base64ImageData);
                
                // Set the diagnosis data and hide loader
                navigateTo('result', {
                    title: diagnosisData.title,
                    status: diagnosisData.status,
                    statusColor: diagnosisData.statusColor,
                    description: diagnosisData.description,
                    solution: diagnosisData.solution,
                    imageSrc: e.target.result
                });
                showResult();
            };
            reader.readAsDataURL(file);
        });
    });
</script>

</body>
</html>